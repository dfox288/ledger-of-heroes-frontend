services:
  # Nuxt.js application running in Node container
  nuxt:
    build:
      context: .
      dockerfile: docker/node/Dockerfile
    entrypoint:
      - /bin/sh
      - /usr/local/bin/docker-entrypoint-dev.sh
    container_name: dnd-frontend-nuxt
    restart: unless-stopped
    ports:
      - "3000:3000"    # Nuxt dev server
      - "24678:24678"  # Nuxt HMR WebSocket
      - "6006:6006"    # Storybook dev server
    volumes:
      - .:/app
      - ./docker/node/entrypoint-dev.sh:/usr/local/bin/docker-entrypoint-dev.sh
      - ../image-generator/output:/app/public/images/generated:ro
    environment:
      - NODE_ENV=development
      - NUXT_HOST=0.0.0.0
      - NUXT_PORT=3000
      - NUXT_PUBLIC_API_BASE=${NUXT_PUBLIC_API_BASE:-http://host.docker.internal:8080/api/v1}
      - NUXT_PUBLIC_API_DOCS_URL=${NUXT_PUBLIC_API_DOCS_URL:-http://host.docker.internal:8080/docs/api.json}
    networks:
      - dnd-network

  # Nginx reverse proxy
  nginx:
    image: nginx:1.27-alpine
    container_name: dnd-frontend-nginx
    restart: unless-stopped
    ports:
      - "8081:80"  # Frontend accessible at http://localhost:8081
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./docker/nginx/conf.d:/etc/nginx/conf.d:ro
      - ../image-generator/output:/usr/share/nginx/html/images/generated:ro
    depends_on:
      - nuxt
    networks:
      - dnd-network

volumes:
  nuxt_node_modules:
    driver: local

networks:
  dnd-network:
    driver: bridge
