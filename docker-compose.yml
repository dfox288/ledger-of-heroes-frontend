services:
  # Nuxt.js application running in Node container
  nuxt:
    build:
      context: .
      dockerfile: docker/node/Dockerfile
    entrypoint:
      - /bin/sh
      - /usr/local/bin/docker-entrypoint-dev.sh
    container_name: loh-frontend-nuxt
    restart: unless-stopped
    ports:
      - "4000:3000"    # Nuxt dev server
      - "34678:24678"  # Nuxt HMR WebSocket
      - "6006:6006"    # Storybook dev server
    volumes:
      - .:/app
      - ./docker/node/entrypoint-dev.sh:/usr/local/bin/docker-entrypoint-dev.sh
      - ../image-generator/output:/app/public/images/generated:ro
    environment:
      - NODE_ENV=development
      - NUXT_HOST=0.0.0.0
      - NUXT_PORT=3000
      - NUXT_PUBLIC_API_BASE=${NUXT_PUBLIC_API_BASE:-http://host.docker.internal:8080/api/v1}
      - NUXT_PUBLIC_API_DOCS_URL=${NUXT_PUBLIC_API_DOCS_URL:-http://host.docker.internal:8080/docs/api.json}
    networks:
      - loh-network
    # =========================================================================
    # RESOURCE LIMITS - Prevents test suite from crashing the host machine
    # =========================================================================
    # Without limits, Vitest can consume all available memory causing swap
    # thrashing and CPU spikes. These limits ensure graceful failure instead
    # of system-wide impact.
    # =========================================================================
    deploy:
      resources:
        limits:
          cpus: '4'        # Max 4 CPU cores (adjust based on your machine)
          memory: 6G       # Max 6GB RAM (enough for tests + dev server)
        reservations:
          cpus: '1'        # Guarantee at least 1 core
          memory: 2G       # Guarantee at least 2GB RAM

  # Nginx reverse proxy
  nginx:
    image: nginx:1.27-alpine
    container_name: loh-frontend-nginx
    restart: unless-stopped
    ports:
      - "8081:80"  # Frontend accessible at http://localhost:8081
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./docker/nginx/conf.d:/etc/nginx/conf.d:ro
      - ../image-generator/output:/usr/share/nginx/html/images/generated:ro
    depends_on:
      - nuxt
    networks:
      - loh-network

volumes:
  nuxt_node_modules:
    driver: local

networks:
  loh-network:
    driver: bridge
