#!/usr/bin/env node

/**
 * Sync API Types from OpenAPI Spec
 *
 * Fetches the OpenAPI spec from the backend and generates TypeScript types.
 * Run manually via: npm run types:sync
 */

import fs from 'node:fs'
import path from 'node:path'
import { fileURLToPath } from 'node:url'

const __filename = fileURLToPath(import.meta.url)
const __dirname = path.dirname(__filename)

// Configuration
const API_SPEC_URL = process.env.NUXT_API_SPEC_URL || 'http://localhost:8080/docs/api.json'
const OUTPUT_FILE = path.resolve(__dirname, '../app/types/api/generated.ts')
const MAX_RETRIES = 3
const RETRY_DELAY_MS = 2000

/**
 * Fetch OpenAPI spec with retry logic
 */
async function fetchOpenAPISpec(url, retries = MAX_RETRIES) {
  console.log(`üîÑ Fetching OpenAPI spec from ${url}...`)

  for (let attempt = 1; attempt <= retries; attempt++) {
    try {
      const response = await fetch(url, {
        signal: AbortSignal.timeout(10000) // 10s timeout
      })

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`)
      }

      const spec = await response.json()
      const sizeKB = Math.round(JSON.stringify(spec).length / 1024)
      console.log(`‚úÖ Spec downloaded (${sizeKB} KB)`)

      return spec
    } catch (error) {
      if (attempt === retries) {
        console.error(`‚ùå Error: ${error.message}`)

        if (error.message.includes('ECONNREFUSED')) {
          console.error('\nüí° Backend API not reachable. Start it with:')
          console.error('   cd ../importer && docker compose up -d\n')
        }

        process.exit(1)
      }

      console.log(`‚ö†Ô∏è  Attempt ${attempt}/${retries} failed, retrying in ${RETRY_DELAY_MS}ms...`)
      await new Promise(resolve => setTimeout(resolve, RETRY_DELAY_MS))
    }
  }
}

/**
 * Generate TypeScript types using openapi-typescript
 */
async function generateTypes(spec) {
  console.log('\nüîß Generating TypeScript types...')

  try {
    // Import openapi-typescript v7 API
    const { default: openapiTS, astToString } = await import('openapi-typescript')

    // Generate AST from spec
    const ast = await openapiTS(spec)

    // Convert AST to TypeScript string
    let output = astToString(ast)

    // Add custom header comment
    const header = `/**
 * This file was auto-generated by openapi-typescript.
 * Do not make direct changes to the file.
 *
 * Generated from: ${API_SPEC_URL}
 * Generated at: ${new Date().toISOString()}
 *
 * To regenerate: npm run types:sync
 */

`
    output = header + output

    // Ensure output directory exists
    const outputDir = path.dirname(OUTPUT_FILE)
    if (!fs.existsSync(outputDir)) {
      fs.mkdirSync(outputDir, { recursive: true })
    }

    // Save to file
    fs.writeFileSync(OUTPUT_FILE, output, 'utf8')
    console.log(`‚úÖ Generated ${path.relative(process.cwd(), OUTPUT_FILE)}`)

    return output
  } catch (error) {
    console.error(`‚ùå Generation failed: ${error.message}`)
    process.exit(1)
  }
}

/**
 * Compare with previous version and report changes
 */
function reportChanges(newOutput) {
  console.log('\nüìä Changes detected:')

  if (!fs.existsSync(OUTPUT_FILE)) {
    console.log('  - Initial generation (no previous file)')
    return
  }

  try {
    const oldOutput = fs.readFileSync(OUTPUT_FILE, 'utf8')

    if (oldOutput === newOutput) {
      console.log('  - No changes detected')
      return
    }

    // Simple line-based comparison
    const oldLines = oldOutput.split('\n').length
    const newLines = newOutput.split('\n').length
    const diff = newLines - oldLines

    if (diff > 0) {
      console.log(`  - Added ~${diff} lines`)
    } else if (diff < 0) {
      console.log(`  - Removed ~${Math.abs(diff)} lines`)
    } else {
      console.log('  - Modified (same line count)')
    }

    console.log('\nüí° Review changes with: git diff app/types/api/generated.ts')
  } catch (error) {
    console.log('  - Unable to compare (previous file not readable)')
  }
}

/**
 * Main execution
 */
async function main() {
  console.log('üöÄ OpenAPI Type Sync\n')

  // Read old content for comparison
  let oldOutput = ''
  if (fs.existsSync(OUTPUT_FILE)) {
    oldOutput = fs.readFileSync(OUTPUT_FILE, 'utf8')
  }

  // Fetch spec and generate types
  const spec = await fetchOpenAPISpec(API_SPEC_URL)
  const newOutput = await generateTypes(spec)

  // Report changes
  reportChanges(newOutput)

  console.log('\n‚úÖ Types synced successfully!')
  console.log('\nüí° Next steps:')
  console.log('  - Run "npm run typecheck" to verify compatibility')
  console.log('  - Run "npm run test" to ensure tests pass')
  console.log('  - Commit changes: git add app/types/api/generated.ts')
}

// Run
main().catch(error => {
  console.error('‚ùå Unexpected error:', error)
  process.exit(1)
})
