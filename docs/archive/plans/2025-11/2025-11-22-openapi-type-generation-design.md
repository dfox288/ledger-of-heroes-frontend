# OpenAPI Type Generation Design

**Date:** 2025-11-22
**Status:** Approved for Implementation
**Approach:** openapi-typescript with hybrid manual extensions

---

## Overview

This design establishes automatic TypeScript type generation from the Laravel backend's OpenAPI specification to achieve full type safety across all API interactions while maintaining the ability to extend types with custom application logic.

**Core Goals:**
- **Full type safety** for all API responses (eliminate `unknown[]` types)
- **Single source of truth** (OpenAPI spec from backend)
- **Manual sync workflow** (`npm run types:sync` command)
- **Hybrid approach** (generated base types + manual extensions)

---

## Architecture

### Three-Layer Type System

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Components / Pages / Composables                           â”‚
â”‚  (Use application types)                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Application Types Layer                                    â”‚
â”‚  app/types/api/entities.ts, common.ts                       â”‚
â”‚  (Manual, version-controlled, extends generated types)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Generated Types Layer                                      â”‚
â”‚  app/types/api/generated.ts                                 â”‚
â”‚  (Auto-generated from OpenAPI, committed to Git)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Backend OpenAPI Spec                                       â”‚
â”‚  http://localhost:8080/docs/api.json                        â”‚
â”‚  (Laravel API, single source of truth)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Data Flow

1. **Backend defines API** via OpenAPI spec
2. **Developer runs sync** (`npm run types:sync`)
3. **Script generates types** from spec â†’ `generated.ts`
4. **Application types extend** generated types with custom logic
5. **Components use** application types (full type safety)

---

## File Structure

### New Files

```
app/types/api/
â”œâ”€â”€ generated.ts          # â† NEW: Auto-generated, readonly, committed
â”œâ”€â”€ entities.ts           # â† MODIFIED: Import from generated.ts
â”œâ”€â”€ common.ts             # â† MODIFIED: Import shared types from generated.ts
â””â”€â”€ index.ts              # â† MODIFIED: Re-export application types

scripts/
â””â”€â”€ sync-api-types.js     # â† NEW: Sync script
```

### Package Scripts

```json
{
  "scripts": {
    "types:sync": "node scripts/sync-api-types.js",
    "typecheck": "nuxt typecheck"
  }
}
```

---

## Type Extension Pattern

### Generated Types (Auto-Generated, Don't Edit)

```typescript
// app/types/api/generated.ts
/**
 * This file was auto-generated by openapi-typescript.
 * Do not make direct changes to the file.
 *
 * Generated from: http://localhost:8080/docs/api.json
 * Generated at: 2025-11-22T10:30:00.000Z
 */

export interface components {
  schemas: {
    Spell: {
      id: number
      name: string
      slug: string
      level: number
      school?: {
        id: number
        code: string
        name: string
      }
      casting_time: string
      range: string
      description: string
      is_ritual: boolean
      needs_concentration: boolean
      components?: string
      material_components?: string
      duration?: string
      higher_levels?: string
      effects?: Array<{
        id: number
        type: string
        damage_dice?: string
        damage_type?: { id: number; name: string }
        healing_dice?: string
        // ... full structure from backend
      }>
      classes?: Array<{ id: number; name: string; slug: string }>
      random_tables?: Array<{
        id: number
        name: string
        dice: string
        results: Array<{ min: number; max: number; result_text: string }>
      }>
      saving_throws?: Array<{
        id: number
        ability_score: { id: number; code: string; name: string }
        dc?: number
        save_type: string
        effect: string
      }>
      conditions?: Array<{ id: number; name: string; slug: string }>
      tags?: Array<{ id: number; name: string; slug: string }>
      sources?: Array<{
        id: number
        code: string
        name: string
        publisher?: string
        year?: number
      }>
    }
    // ... Item, Race, CharacterClass, Background, Feat, etc.
  }
}
```

### Application Types (Manual Extensions)

```typescript
// app/types/api/entities.ts
import type { components } from './generated'

/**
 * Spell entity from D&D 5e API
 *
 * Base type generated from OpenAPI spec.
 * Extended with application-specific utilities.
 *
 * Used in: SpellCard, spell detail pages, tests
 * API endpoint: /api/v1/spells
 */
export type SpellFromAPI = components['schemas']['Spell']

export interface Spell extends SpellFromAPI {
  // Add custom computed properties, utilities, etc. here
  // Example (if needed):
  // displayLevel?: string
  // schoolColor?: string
}

// OR, if no extensions needed, just re-export:
// export type Spell = SpellFromAPI
```

### Benefits of Hybrid Approach

âœ… **Full type safety** - Nested structures (effects, traits, modifiers) are fully typed
âœ… **API changes flow automatically** - Backend adds field â†’ sync â†’ types update â†’ compiler catches usage
âœ… **Custom extensions coexist** - Add computed properties, utilities without touching generated code
âœ… **Clear separation** - Generated (readonly) vs. hand-written (editable)
âœ… **Backward compatible** - Existing code continues working, migrate incrementally

---

## Sync Script Implementation

### Script: `scripts/sync-api-types.js`

**Responsibilities:**

1. **Fetch OpenAPI Spec**
   - From `http://localhost:8080/docs/api.json` (configurable via env)
   - Handle network errors gracefully (backend not running, timeout, etc.)
   - Validate JSON structure (ensure it's valid OpenAPI 3.x)

2. **Generate Types**
   - Run `openapi-typescript` programmatically (not CLI)
   - Output to `app/types/api/generated.ts`
   - Add file header comment warning not to edit manually
   - Include generation timestamp and source URL

3. **Report Changes**
   - Compare new generated file vs. old (if exists)
   - Show summary: schemas added, modified, removed
   - Warn if potential breaking changes (removed fields, type changes)
   - Exit with success (0) for clean sync, non-zero for errors

4. **Error Handling**
   - Backend not running â†’ "Backend API not reachable. Start with: cd ../importer && docker compose up -d"
   - Invalid spec â†’ Show OpenAPI validation errors
   - Network timeout â†’ Retry with exponential backoff (3 attempts)
   - Write failure â†’ Check file permissions

### User Experience

```bash
$ npm run types:sync

ğŸ”„ Fetching OpenAPI spec from http://localhost:8080/docs/api.json...
âœ… Spec downloaded (125 KB)

ğŸ”§ Generating TypeScript types...
âœ… Generated app/types/api/generated.ts

ğŸ“Š Changes detected:
  - Modified: Spell schema (added 'tags' field)
  - Modified: Item schema (changed 'effects' structure)
  - Added: SavingThrow schema
  - Added: 2 new endpoints

âœ… Types synced successfully!
ğŸ’¡ Next steps:
  - Run 'npm run typecheck' to verify compatibility
  - Run 'npm run test' to ensure tests pass
  - Commit changes: git add app/types/api/generated.ts
```

**Error Example:**

```bash
$ npm run types:sync

ğŸ”„ Fetching OpenAPI spec from http://localhost:8080/docs/api.json...
âŒ Error: Backend API not reachable (ECONNREFUSED)

ğŸ’¡ Start the backend first:
   cd ../importer && docker compose up -d

Then retry: npm run types:sync
```

---

## Migration Strategy

### Phase 1: Setup (30 minutes, No Breaking Changes)

**Goal:** Install tooling, generate initial types, don't break anything

**Tasks:**
1. Install `openapi-typescript` as dev dependency
2. Create `scripts/sync-api-types.js` script
3. Add `npm run types:sync` to package.json
4. Run sync to generate initial `app/types/api/generated.ts`
5. Commit generated file
6. Verify `npm run typecheck` still passes

**Outcome:** Infrastructure ready, existing code unchanged

---

### Phase 2: Gradual Migration (1-2 hours)

**Goal:** Migrate entity types one-by-one to use generated types

**Strategy:** Pick one entity, migrate, test, repeat

**Per-Entity Steps (15 minutes each):**

1. **Update interface to extend generated type**
   ```typescript
   // Before:
   export interface Spell {
     id: number
     name: string
     effects?: unknown[]
   }

   // After:
   import type { components } from './generated'
   type SpellFromAPI = components['schemas']['Spell']
   export interface Spell extends SpellFromAPI {}
   ```

2. **Run typecheck** â†’ Fix any type errors in components
3. **Run tests** â†’ Fix any test failures
4. **Manual verification** â†’ Check page in browser
5. **Commit** â†’ "refactor: Migrate Spell type to OpenAPI-generated base"

**Migration Order:**
1. Spell (most complete, good test coverage)
2. Item (complex nested types, good validation)
3. Race, Class, Background, Feat (similar patterns)
4. Common types (Source, Modifier, AbilityScore, etc.)

**Outcome:** All entity types using generated base, full type safety

---

### Phase 3: Cleanup (30 minutes)

**Goal:** Remove duplicate manual definitions, polish

**Tasks:**
1. Remove duplicate manual type definitions (now in generated.ts)
2. Keep only custom extensions that add value
3. Update JSDoc comments to reference generated types
4. Remove `unknown[]` workarounds from component code
5. Run full test suite (all 545 tests)
6. Commit: "refactor: Complete OpenAPI type migration, remove manual duplicates"

**Outcome:** Clean, maintainable type system with no duplication

---

### Phase 4: Maintenance (Ongoing)

**When to Sync:**
- After backend API changes (new fields, endpoints, etc.)
- Weekly/monthly proactive check for drift
- Before major frontend features that depend on API data

**Workflow:**
```bash
# 1. Pull backend changes
cd ../importer && git pull && docker compose restart

# 2. Sync types
cd ../frontend && npm run types:sync

# 3. Verify
npm run typecheck && npm run test

# 4. Fix breaking changes (if any)
# Update components to match new types

# 5. Commit
git add app/types/api/generated.ts
git commit -m "chore: Sync API types from backend"
```

---

## Testing & Validation

### Type Checking

**Automated:**
- `npm run typecheck` catches type mismatches
- Run after every sync
- Run in CI/CD on every PR

**Manual:**
- Visual inspection of generated types
- Verify nested structures match expectations

### Test Coverage

**Existing 545 Tests:**
- Validate runtime compatibility
- If sync changes types â†’ tests fail if components break
- This is **good** - early detection of breaking API changes

**New Tests (Optional):**
- Sync script unit tests (fetch, generate, report)
- Type assertion tests (verify generated structure matches expectations)

### Validation Workflow

**After Running `types:sync`:**
```bash
# 1. Type check
npm run typecheck
# â†’ Should pass if no breaking changes
# â†’ If fails: backend changed types, update components

# 2. Run tests
npm run test
# â†’ Should pass if components compatible
# â†’ If fails: fix component logic to match new types

# 3. Manual verification
docker compose restart nuxt
# â†’ Check key pages in browser (spells, items, etc.)
# â†’ Verify data displays correctly
```

**Before Committing:**
```bash
# Full quality check
npm run lint && npm run typecheck && npm run test
```

**In CI/CD:**
- Run `typecheck` on every PR
- Fail PR if types don't match generated types
- Catch drift early

---

## Developer Workflow

### Daily Development (No Backend Changes)

**No action needed** - use existing types, business as usual

### After Backend API Update

```bash
# 1. Backend deployed new API version
cd ../importer && git pull && docker compose up -d

# 2. Sync frontend types
cd ../frontend
npm run types:sync

# 3. Verify compatibility
npm run typecheck  # Check for type errors
npm run test       # Run test suite

# 4. Fix any breaking changes (if needed)
# Examples:
# - Backend renamed field: Update component references
# - Backend changed type: Update component logic
# - Backend removed field: Add optional chaining (?)

# 5. Commit updated types
git add app/types/api/generated.ts
git commit -m "chore: Sync API types (added tags field to Spell)"
```

### Periodic Proactive Sync

```bash
# Check if backend has changes you haven't synced
npm run types:sync

# Check what changed
git diff app/types/api/generated.ts

# If changes: review, test, commit
# If no changes: no action needed
```

---

## Benefits

### For Developers

âœ… **Full IntelliSense** - Autocomplete for all API fields, including nested structures
âœ… **Catch errors early** - TypeScript catches field name typos at compile time
âœ… **Refactoring confidence** - Rename fields â†’ compiler finds all usages
âœ… **Less guesswork** - Know exactly what fields API returns
âœ… **Better onboarding** - New devs see API structure in types

### For Team

âœ… **Single source of truth** - Backend defines types, frontend imports them
âœ… **API contract enforcement** - Breaking backend changes fail frontend build
âœ… **Less manual sync work** - No more manually updating types when backend changes
âœ… **Version control tracking** - Git history shows API evolution
âœ… **Easier collaboration** - Backend and frontend teams aligned on data structures

### For Project

âœ… **Type safety** - Eliminate `unknown[]` and `any` types
âœ… **Runtime safety** - Fewer bugs from mismatched expectations
âœ… **Maintainability** - Less code duplication, easier to update
âœ… **Scalability** - Handles growing API complexity automatically

---

## Risks & Mitigations

### Risk: Generated types might be verbose or unreadable

**Mitigation:**
- Application types layer adds readable aliases
- Custom JSDoc comments explain domain concepts
- Re-export with better names if needed

### Risk: Breaking backend changes might block frontend development

**Mitigation:**
- Sync is manual, not automatic (developer controls when)
- Git history allows reverting to previous types
- Backend should follow semantic versioning (non-breaking changes)

### Risk: Developers might forget to sync

**Mitigation:**
- Document sync workflow in CLAUDE.md
- Include in onboarding checklist
- Consider periodic reminder (weekly team standup)
- Optional: Add pre-commit hook to warn if generated.ts is old

### Risk: Sync script might fail in edge cases

**Mitigation:**
- Comprehensive error handling (network, validation, etc.)
- Clear error messages with recovery instructions
- Retry logic for transient failures
- Fallback: Manual generation with `openapi-typescript` CLI

---

## Success Criteria

### Immediate (After Implementation)

âœ… `npm run types:sync` successfully generates `app/types/api/generated.ts`
âœ… All existing tests pass (545 tests)
âœ… `npm run typecheck` passes with no new errors
âœ… At least one entity (Spell) migrated to use generated types

### Short-Term (1-2 Weeks)

âœ… All 6 entity types migrated to generated types
âœ… No `unknown[]` types remaining in entities
âœ… Full IntelliSense for nested API structures
âœ… Documentation updated (CLAUDE.md, CURRENT_STATUS.md)

### Long-Term (Ongoing)

âœ… Sync workflow integrated into team habits
âœ… TypeScript error count reduced (180 â†’ <50)
âœ… Faster development (less time looking up API structure)
âœ… Fewer runtime bugs from type mismatches

---

## Future Enhancements (Out of Scope)

**Not in this design, but possible later:**

- **Automatic sync on backend changes** (webhook, polling, etc.)
- **Generate API client code** (fetch functions, not just types)
- **Zod schema generation** for runtime validation
- **Mock data generation** from OpenAPI examples
- **Pre-commit hook** to warn if types stale
- **CI/CD type drift detection** (fail if local types differ from backend)

---

## Related Documentation

- **OpenAPI Spec:** http://localhost:8080/docs/api.json
- **openapi-typescript:** https://github.com/drwpow/openapi-typescript
- **Backend CLAUDE.md:** `../importer/CLAUDE.md`
- **Frontend CLAUDE.md:** `CLAUDE.md` (update after implementation)
- **Current Status:** `docs/CURRENT_STATUS.md` (update after implementation)

---

## Implementation Plan

**Next step:** Use `superpowers:using-git-worktrees` skill to set up isolated workspace, then `superpowers:writing-plans` skill to create detailed implementation plan.

**Estimated Timeline:**
- **Setup (Phase 1):** 30 minutes
- **Migration (Phase 2):** 1-2 hours
- **Cleanup (Phase 3):** 30 minutes
- **Total:** 2-3 hours

**Recommended Approach:** Follow TDD workflow (write/update tests first, then implementation)

---

**Design Status:** âœ… Approved
**Next Phase:** Worktree setup â†’ Implementation planning
