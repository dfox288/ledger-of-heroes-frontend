# MeisterMind - AI Assistant for D&D Compendium
#
# This workflow:
# 1. Automatically analyzes new issues and provides initial assessment
# 2. Responds to @meistermind mentions in issues and PRs
#
# Place in: .github/workflows/meistermind.yml

name: MeisterMind

on:
  issues:
    types: [opened]
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  pull_request:
    types: [opened, ready_for_review]

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Analyze new issues automatically
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  analyze-issue:
    if: github.event_name == 'issues' && github.event.action == 'opened'
    runs-on: [self-hosted, claude-code]
    timeout-minutes: 10
    permissions:
      contents: read
      issues: write

    steps:
      - uses: actions/checkout@v4

      - name: Get issue content
        id: issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue view ${{ github.event.issue.number }} --json title,body,labels > /tmp/issue.json
          echo "title=$(jq -r '.title' /tmp/issue.json)" >> $GITHUB_OUTPUT

      - name: Analyze Issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Read issue content
          ISSUE_TITLE=$(jq -r '.title' /tmp/issue.json)
          ISSUE_BODY=$(jq -r '.body // "No description provided"' /tmp/issue.json)

          cat << EOF > /tmp/analyze-prompt.txt
          Analyze this GitHub issue. Be helpful and thorough, but don't explain the project back to me.

          Title: ${ISSUE_TITLE}

          Description:
          ${ISSUE_BODY}

          Provide:
          - What's being requested/reported
          - Which files/areas likely need changes
          - Complexity estimate (Low/Medium/High)
          - Suggested approach
          - Clarifying questions if needed

          Skip any preamble. Just analyze.
          EOF

          claude -p "$(cat /tmp/analyze-prompt.txt)" \
            --max-turns 3 \
            --allowedTools "Read" \
            > /tmp/analysis.txt 2>&1

          gh issue comment "${{ github.event.issue.number }}" \
            --body "ðŸŽ² **MeisterMind Analysis**

          $(cat /tmp/analysis.txt)

          ---
          *Need help? Mention @meistermind*"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Respond to @meistermind mentions in issues and PR conversations
  # Note: Inline PR review comments are handled by the review-pr job
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  respond-to-mention:
    if: |
      github.event_name == 'issue_comment' &&
      contains(github.event.comment.body, '@meistermind') &&
      github.event.comment.user.login == 'dfox288'
    runs-on: [self-hosted, claude-code]
    timeout-minutes: 15
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "MeisterMind"
          git config user.email "meistermind@users.noreply.github.com"
          git config url."https://x-access-token:${GH_TOKEN}@github.com/".insteadOf "https://github.com/"

      - name: Get full context
        id: context
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # For issue_comment events, github.event.issue.number works for both issues and PRs
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          # Get issue/PR details
          gh issue view "$ISSUE_NUMBER" --json title,body,comments > /tmp/issue.json

          # Check if it's a PR (github.event.issue.pull_request is truthy for PRs)
          if [ "${{ github.event.issue.pull_request }}" != "" ]; then
            echo "type=pr" >> $GITHUB_OUTPUT
            gh pr diff "$ISSUE_NUMBER" > /tmp/diff.txt 2>/dev/null || echo "" > /tmp/diff.txt
          else
            echo "type=issue" >> $GITHUB_OUTPUT
            echo "" > /tmp/diff.txt
          fi

          # Get recent comments for context (last 5)
          jq -r '.comments[-5:] | .[] | "[\(.author.login)]: \(.body)"' /tmp/issue.json > /tmp/comments.txt 2>/dev/null || echo "" > /tmp/comments.txt

      - name: Respond
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          ISSUE_TITLE=$(jq -r '.title' /tmp/issue.json)
          ISSUE_BODY=$(jq -r '.body // ""' /tmp/issue.json)

          # Get comment body safely via GitHub API
          COMMENT_BODY=$(gh api /repos/${{ github.repository }}/issues/comments/${{ github.event.comment.id }} --jq '.body')

          # Remove @meistermind mention
          REQUEST=$(echo "$COMMENT_BODY" | sed 's/@meistermind//gi')

          cat << EOF > /tmp/prompt.txt
          You're MeisterMind, helping with this GitHub issue/PR.

          ISSUE: ${ISSUE_TITLE}

          DESCRIPTION:
          ${ISSUE_BODY}

          RECENT DISCUSSION:
          $(cat /tmp/comments.txt)

          EOF

          # Add diff context for PRs
          if [ -s /tmp/diff.txt ]; then
            echo "PR DIFF (truncated):" >> /tmp/prompt.txt
            head -150 /tmp/diff.txt >> /tmp/prompt.txt
            echo "" >> /tmp/prompt.txt
          fi

          cat << EOF >> /tmp/prompt.txt

          REQUEST: ${REQUEST}

          Be helpful and thorough. Don't explain the project or tech stack back to me - just answer the question.

          If creating files/branches:
          - Branch naming: meistermind/issue-${ISSUE_NUMBER}/short-description
          - Work efficiently - don't over-explore the codebase
          - Create the files, commit, push, and create PR in one flow
          - Link PR to issue #${ISSUE_NUMBER}
          - When creating PR, use: gh pr create --fill --body "Closes #${ISSUE_NUMBER}"

          IMPORTANT: If asked to create GitHub workflow files (.github/workflows/*):
          - Do NOT try to push them (you don't have permission)
          - Just create the file locally and explain what it does
          - The file will be uploaded as a downloadable artifact automatically
          EOF

          # Run claude and capture both stdout and stderr
          # Use subshell to capture exit code without failing the step
          set +e
          claude -p "$(cat /tmp/prompt.txt)" \
            --max-turns 15 \
            --allowedTools "Read,Write,Edit,Bash(git:*),Bash(gh:*)" \
            > /tmp/response.txt 2>&1
          CLAUDE_EXIT_CODE=$?
          set -e

          if [ $CLAUDE_EXIT_CODE -eq 0 ]; then
            CLAUDE_SUCCESS=true
          else
            CLAUDE_SUCCESS=false
            echo "" >> /tmp/response.txt
            echo "--- Claude command failed with exit code $CLAUDE_EXIT_CODE ---" >> /tmp/response.txt
          fi

          # If Claude created files but couldn't push (e.g., workflow files),
          # save them for artifact upload
          git diff --name-only HEAD > /tmp/changed-files.txt 2>/dev/null || true
          mkdir -p /tmp/artifacts
          if [ -s /tmp/changed-files.txt ]; then
            while read -r file; do
              if [ -f "$file" ]; then
                mkdir -p "/tmp/artifacts/$(dirname "$file")"
                cp "$file" "/tmp/artifacts/$file"
              fi
            done < /tmp/changed-files.txt
          fi

          # Always post a response - helps debug issues
          if [ -s /tmp/response.txt ]; then
            if [ "$CLAUDE_SUCCESS" = "true" ]; then
              # Success - post normal response
              gh issue comment "$ISSUE_NUMBER" \
                --body "$(cat /tmp/response.txt)

          ---
          *ðŸŽ² @meistermind*"
            else
              # Claude failed - show error details
              gh issue comment "$ISSUE_NUMBER" \
                --body "ðŸŽ² **MeisterMind encountered an issue:**

          \`\`\`
          $(head -50 /tmp/response.txt)
          \`\`\`

          ---
          *@meistermind*"
            fi
          else
            # Response file is empty - something went wrong
            gh issue comment "$ISSUE_NUMBER" \
              --body "ðŸŽ² **MeisterMind couldn't process this request.** The response was empty.

          This usually means:
          - Claude CLI is not properly configured on the runner
          - API authentication issue
          - Rate limiting

          Please check the workflow logs for details.

          ---
          *@meistermind*"
          fi

      - name: Upload created files
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: meistermind-files
          path: /tmp/artifacts/
          if-no-files-found: ignore

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Review PRs when requested
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  review-pr:
    if: |
      github.event_name == 'pull_request_review_comment' &&
      contains(github.event.comment.body, '@meistermind')
    runs-on: [self-hosted, claude-code]
    timeout-minutes: 15
    permissions:
      contents: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Get PR context
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"

          # Get PR details
          gh pr view "$PR_NUMBER" --json title,body,files,commits > /tmp/pr.json

          # Get the diff
          gh pr diff "$PR_NUMBER" > /tmp/diff.txt

      - name: Review PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          PR_TITLE=$(jq -r '.title' /tmp/pr.json)
          PR_BODY=$(jq -r '.body // ""' /tmp/pr.json)
          CHANGED_FILES=$(jq -r '.files[].path' /tmp/pr.json | head -20)

          # Get the review request from comment
          COMMENT_BODY=$(gh api /repos/${{ github.repository }}/pulls/comments/${{ github.event.comment.id }} --jq '.body')
          REQUEST=$(echo "$COMMENT_BODY" | sed 's/@meistermind//gi')

          cat << EOF > /tmp/review-prompt.txt
          Review this PR.

          TITLE: ${PR_TITLE}

          DESCRIPTION:
          ${PR_BODY}

          CHANGED FILES:
          ${CHANGED_FILES}

          DIFF:
          $(head -500 /tmp/diff.txt)

          SPECIFIC REQUEST: ${REQUEST}

          Provide a code review. Focus on:
          - Bugs or logic errors
          - Edge cases
          - Code style and clarity
          - Potential improvements

          Be constructive and specific. Reference line numbers or file names when relevant.
          EOF

          claude -p "$(cat /tmp/review-prompt.txt)" \
            --max-turns 12 \
            --allowedTools "Read,Bash(git diff:*),Bash(git show:*)" \
            > /tmp/review.txt 2>&1

          # Post review as PR comment
          gh pr comment "$PR_NUMBER" \
            --body "## ðŸŽ² MeisterMind Review

          $(cat /tmp/review.txt)

          ---
          *@meistermind*"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Auto-review new PRs
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Skip by adding [skip-review] or [no-review] to PR title
  auto-review-pr:
    if: |
      github.event_name == 'pull_request' &&
      (github.event.action == 'opened' || github.event.action == 'ready_for_review') &&
      github.event.pull_request.draft == false &&
      !contains(github.event.pull_request.title, '[skip-review]') &&
      !contains(github.event.pull_request.title, '[no-review]')
    runs-on: [self-hosted, claude-code]
    timeout-minutes: 15
    permissions:
      contents: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Get PR context
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          gh pr view "$PR_NUMBER" --json title,body,files > /tmp/pr.json
          gh pr diff "$PR_NUMBER" > /tmp/diff.txt

      - name: Review PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          PR_TITLE=$(jq -r '.title' /tmp/pr.json)
          PR_BODY=$(jq -r '.body // ""' /tmp/pr.json)
          CHANGED_FILES=$(jq -r '.files[].path' /tmp/pr.json | head -20)

          cat << EOF > /tmp/review-prompt.txt
          Review this PR.

          TITLE: ${PR_TITLE}

          DESCRIPTION:
          ${PR_BODY}

          CHANGED FILES:
          ${CHANGED_FILES}

          DIFF:
          $(head -500 /tmp/diff.txt)

          Provide a helpful code review. Focus on:
          - Bugs or logic errors
          - Edge cases not handled
          - Code clarity
          - Suggestions for improvement

          Be constructive. If it looks good, say so briefly. Reference specific files/lines when noting issues.
          EOF

          claude -p "$(cat /tmp/review-prompt.txt)" \
            --max-turns 12 \
            --allowedTools "Read,Bash(git diff:*),Bash(git show:*)" \
            > /tmp/review.txt 2>&1

          gh pr comment "$PR_NUMBER" \
            --body "## ðŸŽ² MeisterMind Review

          $(cat /tmp/review.txt)

          ---
          *Want a follow-up review after making changes? Tag @meistermind in your comment.*"
